همانطور که تا اینجا توصیف شد، ما فقط به یک فایل اضافه می‌کنیم—پس چگونه از تمام شدن نهایی فضای دیسک جلوگیری می‌کنیم؟ یک راه حل خوب این است که لاگ را به قطعات با اندازه مشخص تقسیم کنیم، با بستن یک فایل قطعه وقتی به اندازه خاصی می‌رسد، و انجام نوشتن‌های بعدی در یک فایل قطعه جدید. سپس می‌توانیم فشرده‌سازی را روی این قطعات انجام دهیم، همانطور که در [شکل 3-2](#fig_storage_compaction) نشان داده شده است. فشرده‌سازی به معنای دور انداختن کلیدهای تکراری در لاگ، و نگه داشتن فقط آخرین به‌روزرسانی برای هر کلید است.

![ddia 0302](assets/ddia_0302.png)
###### شکل 3-2. فشرده‌سازی یک لاگ به‌روزرسانی کلید-مقدار (شمارش تعداد دفعاتی که هر ویدیوی گربه پخش شده است)، با حفظ فقط جدیدترین مقدار برای هر کلید.

علاوه بر این، از آنجا که فشرده‌سازی اغلب قطعات را بسیار کوچکتر می‌کند (با فرض اینکه یک کلید به طور متوسط چندین بار در یک قطعه بازنویسی می‌شود)، می‌توانیم همزمان با انجام فشرده‌سازی، چندین قطعه را با هم ادغام کنیم، همانطور که در [شکل 3-3](#fig_storage_merging) نشان داده شده است. قطعات پس از نوشته شدن هرگز تغییر نمی‌کنند، بنابراین قطعه ادغام شده در یک فایل جدید نوشته می‌شود. ادغام و فشرده‌سازی قطعات منجمد می‌تواند در یک رشته پس‌زمینه انجام شود، و در حالی که در حال انجام است، ما همچنان می‌توانیم به طور عادی به درخواست‌های خواندن و نوشتن با استفاده از فایل‌های قطعه قدیمی خدمت کنیم. پس از تکمیل فرآیند ادغام، ما درخواست‌های خواندن را به استفاده از قطعه ادغام شده جدید به جای قطعات قدیمی تغییر می‌دهیم—و سپس فایل‌های قطعه قدیمی می‌توانند به سادگی حذف شوند. 